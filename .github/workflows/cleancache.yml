name: Manual Cache Cleanup

on:
  workflow_dispatch:  # åªå…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  cleanup-all-cache:
    name: Clean All Cache
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
    - name: Cleanup All GitHub Actions Cache
      run: |
        echo "å¼€å§‹æ¸…ç†æ‰€æœ‰GitHub Actions Cache..."
        
        # è·å–æ‰€æœ‰cacheæ¡ç›®
        echo "è·å–cacheåˆ—è¡¨..."
        caches=$(gh api repos/${{ github.repository }}/actions/caches --paginate | jq -r '.actions_caches[].id')
        
        if [ -z "$caches" ]; then
          echo "æ²¡æœ‰æ‰¾åˆ°ä»»ä½•cacheï¼Œå¯èƒ½å·²ç»å…¨éƒ¨æ¸…ç†å®Œæ¯•"
          exit 0
        fi
        
        cache_count=$(echo "$caches" | wc -l)
        echo "æ‰¾åˆ° $cache_count ä¸ªcacheæ¡ç›®"
        
        # åˆ é™¤æ‰€æœ‰cache
        counter=0
        for cache_id in $caches; do
          counter=$((counter + 1))
          echo "[$counter/$cache_count] åˆ é™¤cache ID: $cache_id"
          
          if gh api repos/${{ github.repository }}/actions/caches/$cache_id -X DELETE 2>/dev/null; then
            echo "  âœ… æˆåŠŸåˆ é™¤"
          else
            echo "  âŒ åˆ é™¤å¤±è´¥"
          fi
          
          # é¿å…APIé™åˆ¶ï¼Œæ¯åˆ é™¤5ä¸ªcacheåä¼‘æ¯1ç§’
          if [ $((counter % 5)) -eq 0 ]; then
            echo "  ğŸ’¤ ä¼‘æ¯1ç§’..."
            sleep 1
          fi
        done
        
        echo ""
        echo "ğŸ‰ Cacheæ¸…ç†å®Œæˆï¼æ€»å…±å¤„ç†äº† $cache_count ä¸ªcacheæ¡ç›®"
        
        # éªŒè¯æ¸…ç†ç»“æœ
        echo ""
        echo "éªŒè¯æ¸…ç†ç»“æœ..."
        remaining_caches=$(gh api repos/${{ github.repository }}/actions/caches --paginate | jq -r '.actions_caches[].id' | wc -l)
        echo "å‰©ä½™cacheæ•°é‡: $remaining_caches"
        
        if [ "$remaining_caches" -eq 0 ]; then
          echo "âœ… æ‰€æœ‰cacheå·²æˆåŠŸæ¸…ç†ï¼"
        else
          echo "âš ï¸  ä»æœ‰ $remaining_caches ä¸ªcacheæœªæ¸…ç†ï¼Œå¯èƒ½éœ€è¦å†æ¬¡è¿è¡Œ"
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  cleanup-specific-cache:
    name: Clean Specific Cache Types
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
    - name: Cleanup Rust and Docker Cache
      run: |
        echo "æ¸…ç†ç‰¹å®šç±»å‹çš„Cache..."
        
        # æ¸…ç†Rustç›¸å…³cache
        echo "æ¸…ç†Rustç¼–è¯‘cache..."
        rust_caches=$(gh api repos/${{ github.repository }}/actions/caches --paginate | jq -r '.actions_caches[] | select(.key | contains("cargo") or contains("rust") or contains("target")) | .id')
        
        for cache_id in $rust_caches; do
          echo "åˆ é™¤Rust cache ID: $cache_id"
          gh api repos/${{ github.repository }}/actions/caches/$cache_id -X DELETE || echo "åˆ é™¤å¤±è´¥"
        done
        
        # æ¸…ç†Dockerç›¸å…³cache
        echo "æ¸…ç†Dockeræ„å»ºcache..."
        docker_caches=$(gh api repos/${{ github.repository }}/actions/caches --paginate | jq -r '.actions_caches[] | select(.key | contains("buildkit") or contains("docker")) | .id')
        
        for cache_id in $docker_caches; do
          echo "åˆ é™¤Docker cache ID: $cache_id"
          gh api repos/${{ github.repository }}/actions/caches/$cache_id -X DELETE || echo "åˆ é™¤å¤±è´¥"
        done
        
        echo "ç‰¹å®šç±»å‹Cacheæ¸…ç†å®Œæˆï¼"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
